<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">// Generated by CoffeeScript 1.6.3
/*
Copyright (c) 2012-2013 [DeftJS Framework Contributors](http://deftjs.org)
Open source under the [MIT License](http://en.wikipedia.org/wiki/MIT_License).
*/

<span id='Deft-mvc-ViewController'>/**
</span>A lightweight MVC view controller. Full usage instructions in the [DeftJS documentation](https://github.com/deftjs/DeftJS/wiki/ViewController).

First, specify a ViewController to attach to a view:

		Ext.define(&quot;DeftQuickStart.view.MyTabPanel&quot;, {
			extend: &quot;Ext.tab.Panel&quot;,
			controller: &quot;DeftQuickStart.controller.MainController&quot;,
			...
		});

Next, define the ViewController:

		Ext.define(&quot;DeftQuickStart.controller.MainController&quot;, {
			extend: &quot;Deft.mvc.ViewController&quot;,

			init: function() {
				return this.callParent(arguments);
			}

		});

## Inject dependencies using the &lt;u&gt;[`inject` property](https://github.com/deftjs/DeftJS/wiki/Injecting-Dependencies)&lt;/u&gt;:

		Ext.define(&quot;DeftQuickStart.controller.MainController&quot;, {
			extend: &quot;Deft.mvc.ViewController&quot;,
			inject: [&quot;companyStore&quot;],

			config: {
				companyStore: null
			},

			init: function() {
				return this.callParent(arguments);
			}

		});

## Define &lt;u&gt;[references to view components](https://github.com/deftjs/DeftJS/wiki/Accessing-Views)&lt;/u&gt; and &lt;u&gt;[add view listeners](https://github.com/deftjs/DeftJS/wiki/Handling-View-Events)&lt;/u&gt; with the `control` property:

		Ext.define(&quot;DeftQuickStart.controller.MainController&quot;, {
			extend: &quot;Deft.mvc.ViewController&quot;,

			control: {

				// Most common configuration, using an itemId and listener
				manufacturingFilter: {
					change: &quot;onFilterChange&quot;
				},

				// Reference only, with no listeners
				serviceIndustryFilter: true,

				// Configuration using selector, listeners, and event listener options
				salesFilter: {
					selector: &quot;toolbar &gt; checkbox&quot;,
					listeners: {
						change: {
							fn: &quot;onFilterChange&quot;,
							buffer: 50,
							single: true
						}
					}
				}
			},

			init: function() {
				return this.callParent(arguments);
			}

			// Event handlers or other methods here...

		});

## Dynamically monitor view to attach listeners to added components with &lt;u&gt;[live selectors](https://github.com/deftjs/DeftJS/wiki/ViewController-Live-Selectors)&lt;/u&gt;:

		control: {
			manufacturingFilter: {
				live: true,
				listeners: {
					change: &quot;onFilterChange&quot;
				}
			}
		};

## Observe events on injected objects with the &lt;u&gt;[`observe` property](https://github.com/deftjs/DeftJS/wiki/ViewController-Observe-Configuration)&lt;/u&gt;:

		Ext.define(&quot;DeftQuickStart.controller.MainController&quot;, {
			extend: &quot;Deft.mvc.ViewController&quot;,
			inject: [&quot;companyStore&quot;],

			config: {
				companyStore: null
			},

			observe: {
				// Observe companyStore for the update event
				companyStore: {
					update: &quot;onCompanyStoreUpdateEvent&quot;
				}
			},

			init: function() {
				return this.callParent(arguments);
			},

			onCompanyStoreUpdateEvent: function(store, model, operation, fieldNames) {
				// Do something when store fires update event
			}

		});

## Attach companion view controllers using the &lt;u&gt;[`companions` property](https://github.com/deftjs/DeftJS/wiki/ViewController-Companion-Configuration)&lt;/u&gt;:

		Ext.define(&quot;DeftQuickStart.controller.MainController&quot;, {
			extend: &quot;Deft.mvc.ViewController&quot;,
			inject: [&quot;companyStore&quot;],

			config: {
				companyStore: null
			},

			companions: {
				// Create companion view controllers which can also manage the original view
				// This allows a view controller to leverage common behavior provided by other view controllers.
				shoppingCart: &quot;DeftQuickStart.controller.ShoppingCartController&quot;
			},

			init: function() {
				return this.callParent(arguments);
			}

		});
*/

Ext.define('Deft.mvc.ViewController', {
  alternateClassName: ['Deft.ViewController'],
  mixins: ['Deft.mixin.Observer'],
  requires: ['Deft.core.Class', 'Deft.log.Logger', 'Deft.mvc.ComponentSelector', 'Deft.mixin.Observer', 'Deft.mvc.Observer', 'Deft.util.DeftMixinUtils'],
  config: {
<span id='Deft-mvc-ViewController-cfg-view'>    /**
</span>    		* View controlled by this ViewController.
    */

    view: null,
<span id='Deft-mvc-ViewController-cfg-companionInstances'>    /**
</span>    		* @private
    		* Companion ViewController instances.
    */

    companionInstances: null
  },
<span id='Deft-mvc-ViewController-method-constructor'>  constructor: function(config) {
</span>    if (config == null) {
      config = {};
    }
    if (config.view) {
      this.controlView(config.view);
    }
    this.initConfig(config);
    this.createObservers();
    return this;
  },
<span id='Deft-mvc-ViewController-method-init'>  /**
</span>  	* Initialize the ViewController
  */

  init: function() {},
<span id='Deft-mvc-ViewController-method-controlView'>  /**
</span>  	* @protected
  */

  controlView: function(view) {
    if (view instanceof Ext.ClassManager.get('Ext.Component')) {
      this.setView(view);
      this.registeredComponentReferences = {};
      this.registeredComponentSelectors = {};
      if (Ext.getVersion('extjs') != null) {
        if (this.getView().rendered) {
          this.onViewInitialize();
        } else {
          this.getView().on('afterrender', this.onViewInitialize, this, {
            single: true
          });
        }
      } else {
        if (this.getView().initialized) {
          this.onViewInitialize();
        } else {
          this.getView().on('initialize', this.onViewInitialize, this, {
            single: true
          });
        }
      }
      this.createCompanions();
    } else {
      Ext.Error.raise({
        msg: 'Error constructing ViewController: the configured \'view\' is not an Ext.Component.'
      });
    }
  },
<span id='Deft-mvc-ViewController-method-createCompanions'>  /**
</span>  	* @protected
  */

  createCompanions: function() {
    var alias, clazz, _ref, _results;
    this.companionInstances = {};
    _ref = this.companions;
    _results = [];
    for (alias in _ref) {
      clazz = _ref[alias];
      _results.push(this.addCompanion(alias, clazz));
    }
    return _results;
  },
<span id='Deft-mvc-ViewController-method-destroyCompanions'>  /**
</span>  	* @protected
  */

  destroyCompanions: function() {
    var alias, instance, _ref, _results;
    _ref = this.companionInstances;
    _results = [];
    for (alias in _ref) {
      instance = _ref[alias];
      _results.push(this.removeCompanion(alias));
    }
    return _results;
  },
<span id='Deft-mvc-ViewController-method-addCompanion'>  /**
</span>  	* Add a new companion view controller to this view controller.
  	* @param {String} alias The alias for the new companion.
  	* @param {String} class The class name of the companion view controller.
  */

  addCompanion: function(alias, clazz) {
    var error, initialClass, isRecursionStart, newHost, stackMessage;
    if ((this.companionInstances[alias] != null)) {
      Deft.Logger.warn(&quot;The specified companion alias '&quot; + alias + &quot;' already exists.&quot;);
      return;
    }
    isRecursionStart = false;
    if (Deft.mvc.ViewController.companionCreationStack.length === 0) {
      isRecursionStart = true;
    }
    try {
      if (!Ext.Array.contains(Deft.mvc.ViewController.companionCreationStack, Ext.getClassName(this))) {
        Deft.mvc.ViewController.companionCreationStack.push(Ext.getClassName(this));
      } else {
        Deft.mvc.ViewController.companionCreationStack.push(Ext.getClassName(this));
        initialClass = Deft.mvc.ViewController.companionCreationStack[0];
        stackMessage = Deft.mvc.ViewController.companionCreationStack.join(&quot; -&gt; &quot;);
        Deft.mvc.ViewController.companionCreationStack = [];
        Ext.Error.raise({
          msg: &quot;Error creating companions for '&quot; + initialClass + &quot;'. A circular dependency exists in its companions: &quot; + stackMessage
        });
      }
      newHost = Ext.create(clazz);
      newHost.controlView(this.getView());
      this.companionInstances[alias] = newHost;
      if (isRecursionStart) {
        return Deft.mvc.ViewController.companionCreationStack = [];
      }
    } catch (_error) {
      error = _error;
      Deft.Logger.warn(&quot;Error initializing associated view controller: an error occurred while creating an instance of the specified controller: '&quot; + clazz + &quot;'.&quot;);
      Deft.mvc.ViewController.companionCreationStack = [];
      throw error;
    }
  },
<span id='Deft-mvc-ViewController-method-removeCompanion'>  /**
</span>  	* Removes and destroys a companion view controller from this view controller.
  	* @param {String} alias The alias for the companion host to remove
  */

  removeCompanion: function(alias) {
    var error, _ref;
    if (this.companionInstances[alias] == null) {
      Deft.Logger.warn(&quot;The specified companion alias '&quot; + alias + &quot;' cannot be removed because the alias does not exist.&quot;);
    }
    try {
      if ((_ref = this.companionInstances[alias]) != null) {
        _ref.destroy();
      }
      return delete this.companionInstances[alias];
    } catch (_error) {
      error = _error;
      Deft.Logger.warn(&quot;Error destroying associated view controller: an error occurred while destroying the associated controller with the alias '&quot; + alias + &quot;'.&quot;);
      throw error;
    }
  },
<span id='Deft-mvc-ViewController-method-getCompanion'>  /**
</span>  	* Locates a companion view controller by alias.
  	* @param {String} alias The alias for the desired companion instance
  */

  getCompanion: function(alias) {
    return this.companionInstances[alias];
  },
<span id='Deft-mvc-ViewController-method-destroy'>  /**
</span>  	* Destroy the ViewController
  */

  destroy: function() {
    var id, selector;
    for (id in this.registeredComponentReferences) {
      this.removeComponentReference(id);
    }
    for (selector in this.registeredComponentSelectors) {
      this.removeComponentSelector(selector);
    }
    this.removeObservers();
    this.destroyCompanions();
    return true;
  },
<span id='Deft-mvc-ViewController-method-onViewInitialize'>  /**
</span>  	* @private
  */

  onViewInitialize: function() {
    var config, id, listeners, live, originalViewDestroyFunction, selector, self, _ref;
    if (Ext.getVersion('extjs') != null) {
      this.getView().on('beforedestroy', this.onViewBeforeDestroy, this);
    } else {
      self = this;
      originalViewDestroyFunction = this.getView().destroy;
      this.getView().destroy = function() {
        if (self.destroy()) {
          originalViewDestroyFunction.call(this);
        }
      };
    }
    _ref = this.control;
    for (id in _ref) {
      config = _ref[id];
      selector = null;
      if (id !== 'view') {
        if (Ext.isString(config)) {
          selector = config;
        } else if (config.selector != null) {
          selector = config.selector;
        } else {
          selector = '#' + id;
        }
      }
      listeners = null;
      if (Ext.isObject(config.listeners)) {
        listeners = config.listeners;
      } else {
        if (!((config.selector != null) || (config.live != null))) {
          listeners = config;
        }
      }
      live = (config.live != null) &amp;&amp; config.live;
      this.addComponentReference(id, selector, live);
      this.addComponentSelector(selector, listeners, live);
    }
    this.init();
  },
<span id='Deft-mvc-ViewController-method-onViewBeforeDestroy'>  /**
</span>  	* @private
  */

  onViewBeforeDestroy: function() {
    if (this.destroy()) {
      this.getView().un('beforedestroy', this.onViewBeforeDestroy, this);
      return true;
    }
    return false;
  },
<span id='Deft-mvc-ViewController-method-addComponentReference'>  /**
</span>  	* Add a component accessor method the ViewController for the specified view-relative selector.
  */

  addComponentReference: function(id, selector, live) {
    var getterName, matches;
    if (live == null) {
      live = false;
    }
    Deft.Logger.log(&quot;Adding '&quot; + id + &quot;' component reference for selector: '&quot; + selector + &quot;'.&quot;);
    if (this.registeredComponentReferences[id] != null) {
      Ext.Error.raise({
        msg: &quot;Error adding component reference: an existing component reference was already registered as '&quot; + id + &quot;'.&quot;
      });
    }
    if (id !== 'view') {
      getterName = 'get' + Ext.String.capitalize(id);
      if (this[getterName] == null) {
        if (live) {
          this[getterName] = Ext.Function.pass(this.getViewComponent, [selector], this);
        } else {
          matches = this.getViewComponent(selector);
          if (matches == null) {
            Ext.Error.raise({
              msg: &quot;Error locating component: no component(s) found matching '&quot; + selector + &quot;'.&quot;
            });
          }
          this[getterName] = function() {
            return matches;
          };
        }
        this[getterName].generated = true;
      }
    }
    this.registeredComponentReferences[id] = true;
  },
<span id='Deft-mvc-ViewController-method-removeComponentReference'>  /**
</span>  	* Remove a component accessor method the ViewController for the specified view-relative selector.
  */

  removeComponentReference: function(id) {
    var getterName;
    Deft.Logger.log(&quot;Removing '&quot; + id + &quot;' component reference.&quot;);
    if (this.registeredComponentReferences[id] == null) {
      Ext.Error.raise({
        msg: &quot;Error removing component reference: no component reference is registered as '&quot; + id + &quot;'.&quot;
      });
    }
    if (id !== 'view') {
      getterName = 'get' + Ext.String.capitalize(id);
      if (this[getterName].generated) {
        this[getterName] = null;
      }
    }
    delete this.registeredComponentReferences[id];
  },
<span id='Deft-mvc-ViewController-method-getViewComponent'>  /**
</span>  	* Get the component(s) corresponding to the specified view-relative selector.
  */

  getViewComponent: function(selector) {
    var matches;
    if (selector != null) {
      matches = Ext.ComponentQuery.query(selector, this.getView());
      if (matches.length === 0) {
        return null;
      } else if (matches.length === 1) {
        return matches[0];
      } else {
        return matches;
      }
    } else {
      return this.getView();
    }
  },
<span id='Deft-mvc-ViewController-method-addComponentSelector'>  /**
</span>  	* Add a component selector with the specified listeners for the specified view-relative selector.
  */

  addComponentSelector: function(selector, listeners, live) {
    var componentSelector, existingComponentSelector;
    if (live == null) {
      live = false;
    }
    Deft.Logger.log(&quot;Adding component selector for: '&quot; + selector + &quot;'.&quot;);
    existingComponentSelector = this.getComponentSelector(selector);
    if (existingComponentSelector != null) {
      Ext.Error.raise({
        msg: &quot;Error adding component selector: an existing component selector was already registered for '&quot; + selector + &quot;'.&quot;
      });
    }
    componentSelector = Ext.create('Deft.mvc.ComponentSelector', {
      view: this.getView(),
      selector: selector,
      listeners: listeners,
      scope: this,
      live: live
    });
    this.registeredComponentSelectors[selector] = componentSelector;
  },
<span id='Deft-mvc-ViewController-method-removeComponentSelector'>  /**
</span>  	* Remove a component selector with the specified listeners for the specified view-relative selector.
  */

  removeComponentSelector: function(selector) {
    var existingComponentSelector;
    Deft.Logger.log(&quot;Removing component selector for '&quot; + selector + &quot;'.&quot;);
    existingComponentSelector = this.getComponentSelector(selector);
    if (existingComponentSelector == null) {
      Ext.Error.raise({
        msg: &quot;Error removing component selector: no component selector registered for '&quot; + selector + &quot;'.&quot;
      });
    }
    existingComponentSelector.destroy();
    delete this.registeredComponentSelectors[selector];
  },
<span id='Deft-mvc-ViewController-method-getComponentSelector'>  /**
</span>  	* Get the component selectorcorresponding to the specified view-relative selector.
  */

  getComponentSelector: function(selector) {
    return this.registeredComponentSelectors[selector];
  },
<span id='Deft-mvc-ViewController-method-onClassExtended'>  onClassExtended: function(clazz, config) {
</span>    clazz.override({
      constructor: Deft.mvc.ViewController.mergeSubclassInterceptor()
    });
    return true;
  },
  statics: {
<span id='Deft-mvc-ViewController-static-property-companionCreationStack'>    companionCreationStack: [],
</span><span id='Deft-mvc-ViewController-static-method-mergeSubclassInterceptor'>    mergeSubclassInterceptor: function() {
</span>      return function(config) {
        var companionPropertyName, controlPropertyName;
        if (config == null) {
          config = {};
        }
        controlPropertyName = &quot;control&quot;;
        companionPropertyName = &quot;companions&quot;;
        if (this[controlPropertyName] == null) {
          this[controlPropertyName] = {};
        }
        if (this[companionPropertyName] == null) {
          this[companionPropertyName] = [];
        }
        if (Ext.Object.getSize(this[controlPropertyName]) &gt; 0) {
          Deft.util.DeftMixinUtils.mergeSuperclassProperty(this, controlPropertyName, Deft.mvc.ViewController.controlMergeHandler);
          Deft.util.DeftMixinUtils.mergeSuperclassProperty(this, companionPropertyName, Deft.mvc.ViewController.companionMergeHandler);
          this[Deft.util.DeftMixinUtils.parentConstructorForVersion(this)](arguments);
          return this;
        }
        return this[Deft.util.DeftMixinUtils.parentConstructorForVersion(this)](arguments);
      };
    },
<span id='Deft-mvc-ViewController-static-method-controlMergeHandler'>    controlMergeHandler: function(originalParentControl, originalChildControl) {
</span>      var childControl, matchedPostMergeParentTargetConfig, originalParentControlConfig, originalParentControlTarget, parentControl;
      parentControl = Ext.isObject(originalParentControl) ? Ext.clone(originalParentControl) : {};
      childControl = Ext.isObject(originalChildControl) ? Ext.clone(originalChildControl) : {};
      parentControl = Ext.merge(parentControl, childControl);
      for (originalParentControlTarget in originalParentControl) {
        originalParentControlConfig = originalParentControl[originalParentControlTarget];
        if (parentControl[originalParentControlTarget] != null) {
          matchedPostMergeParentTargetConfig = parentControl[originalParentControlTarget];
          if (originalParentControlConfig.selector === void 0 || matchedPostMergeParentTargetConfig.selector === originalParentControlConfig.selector) {
            Deft.mvc.ViewController.detectReplacedListeners(matchedPostMergeParentTargetConfig, originalParentControlConfig, originalChildControl, originalParentControlTarget);
          }
        }
      }
      return parentControl;
    },
<span id='Deft-mvc-ViewController-static-method-detectReplacedListeners'>    detectReplacedListeners: function(matchedPostMergeParentTargetConfig, originalParentControlConfig, originalChildControl, originalParentControlTarget) {
</span>      var matchedPostMergeListeners, normalizedConfig, originalListeners;
      if (Deft.mvc.ViewController.areBothConfigsComplex(matchedPostMergeParentTargetConfig, originalParentControlConfig, originalChildControl, originalParentControlTarget)) {
        matchedPostMergeListeners = matchedPostMergeParentTargetConfig.listeners;
        originalListeners = originalParentControlConfig.listeners;
        Deft.mvc.ViewController.applyReplacedListeners(originalListeners, matchedPostMergeListeners, function(listenerArray, eventConfig) {
          listenerArray.push(Ext.clone(eventConfig));
        });
      } else if (Deft.mvc.ViewController.hasMixedConfigs(matchedPostMergeParentTargetConfig, originalParentControlConfig)) {
        normalizedConfig = Deft.mvc.ViewController.normalizeMixedConfigs(originalParentControlConfig, matchedPostMergeParentTargetConfig);
        Deft.mvc.ViewController.applyReplacedListeners(normalizedConfig.listeners, matchedPostMergeParentTargetConfig.listeners, function(listenerArray, eventConfig) {
          listenerArray.push(Ext.clone(eventConfig));
        });
      } else {
        Deft.mvc.ViewController.applyReplacedListeners(originalParentControlConfig, matchedPostMergeParentTargetConfig, function(listenerArray, eventConfig) {
          listenerArray.push(Ext.clone(eventConfig));
          return Ext.Array.unique(listenerArray);
        });
      }
    },
<span id='Deft-mvc-ViewController-static-method-applyReplacedListeners'>    applyReplacedListeners: function(originalControlConfig, postMergeControlConfig, applyFn) {
</span>      var applyResult, dupeCheckListener, eventConfig, isDuplicateListener, thisEvent, _i, _len, _ref;
      for (thisEvent in originalControlConfig) {
        eventConfig = originalControlConfig[thisEvent];
        if (postMergeControlConfig[thisEvent]) {
          if (!Ext.isArray(postMergeControlConfig[thisEvent])) {
            postMergeControlConfig[thisEvent] = [postMergeControlConfig[thisEvent]];
          }
          isDuplicateListener = false;
          _ref = postMergeControlConfig[thisEvent];
          for (_i = 0, _len = _ref.length; _i &lt; _len; _i++) {
            dupeCheckListener = _ref[_i];
            if (dupeCheckListener === eventConfig || ((dupeCheckListener.fn !== void 0 || eventConfig.fn !== void 0) &amp;&amp; dupeCheckListener.fn === eventConfig.fn)) {
              isDuplicateListener = true;
              break;
            }
          }
          if (!isDuplicateListener) {
            applyResult = applyFn(postMergeControlConfig[thisEvent], eventConfig);
            if (applyResult !== void 0) {
              postMergeControlConfig[thisEvent] = applyResult;
            }
          }
        }
      }
    },
<span id='Deft-mvc-ViewController-static-method-areBothConfigsComplex'>    areBothConfigsComplex: function(matchedPostMergeParentTargetConfig, originalParentControlConfig, originalChildControl, originalParentControlTarget) {
</span>      return Ext.isObject(matchedPostMergeParentTargetConfig.listeners) &amp;&amp; Ext.isObject(originalParentControlConfig.listeners) &amp;&amp; (originalChildControl[originalParentControlTarget] === void 0 || Ext.isObject(originalChildControl[originalParentControlTarget].listeners));
    },
<span id='Deft-mvc-ViewController-static-method-hasMixedConfigs'>    hasMixedConfigs: function(matchedPostMergeParentTargetConfig, originalParentControlConfig) {
</span>      return Ext.isObject(matchedPostMergeParentTargetConfig.listeners) || Ext.isObject(originalParentControlConfig.listeners);
    },
<span id='Deft-mvc-ViewController-static-method-normalizeMixedConfigs'>    normalizeMixedConfigs: function(originalParentControlConfig, matchedPostMergeParentTargetConfig) {
</span>      var matchedParentKey, matchedParentValue, normalizedOriginalParentControlConfig;
      normalizedOriginalParentControlConfig = Ext.clone(originalParentControlConfig);
      if (Ext.isObject(matchedPostMergeParentTargetConfig.listeners)) {
        if (!Ext.isObject(normalizedOriginalParentControlConfig.listeners)) {
          normalizedOriginalParentControlConfig.listeners = {};
        }
        for (matchedParentKey in matchedPostMergeParentTargetConfig) {
          matchedParentValue = matchedPostMergeParentTargetConfig[matchedParentKey];
          if (matchedParentKey !== &quot;listeners&quot;) {
            normalizedOriginalParentControlConfig.listeners[matchedParentKey] = Ext.clone(matchedParentValue);
            if (matchedPostMergeParentTargetConfig.listeners[matchedParentKey] === void 0) {
              matchedPostMergeParentTargetConfig.listeners[matchedParentKey] = Ext.clone(matchedParentValue);
              delete matchedPostMergeParentTargetConfig[matchedParentKey];
            }
          }
        }
      }
      return normalizedOriginalParentControlConfig;
    },
<span id='Deft-mvc-ViewController-static-method-companionMergeHandler'>    companionMergeHandler: function(parentCompanions, childCompanions) {
</span>      return Ext.merge(Ext.clone(parentCompanions), Ext.clone(childCompanions));
    }
  }
});
</pre>
</body>
</html>
